---
import WideLayout from "@layouts/WideLayout.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import Hr from "@components/Hr.astro";

import tools from "@data/ai.json";

// Group by category for initial render
const categories = Array.from(
  tools.reduce((map, t) => {
    const list = map.get(t.category) || [];
    list.push(t);
    map.set(t.category, list);
    return map;
  }, new Map())
);
---

<WideLayout>
  <div class="wide-layout">
    <Header activeNav="ai" />

    <main id="main-content">
      <section id="ai-hero">
        <h1>AI 工具与资源</h1>
        <p class="lead text-skin-muted">
          精选实用的 AI 工具、模型和开发资源。点击条目即可访问对应网站。
        </p>
      </section>

      <Hr />

      <section id="ai-search">
        <label class="relative block max-w-xl">
          <span
            class="absolute inset-y-0 left-0 flex items-center pl-2 opacity-75"
          >
            <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true"
              ><path
                d="M19.023 16.977a35.13 35.13 0 0 1-1.367-1.384c-.372-.378-.596-.653-.596-.653l-2.8-1.337A6.962 6.962 0 0 0 16 9c0-3.859-3.14-7-7-7S2 5.141 2 9s3.14 7 7 7c1.763 0 3.37-.66 4.603-1.739l1.337 2.8s.275.224.653.596c.387.363.896.854 1.384 1.367l1.358 1.392.604.646 2.121-2.121-.646-.604c-.379-.372-.885-.866-1.391-1.36zM9 14c-2.757 0-5-2.243-5-5s2.243-5 5-5 5 2.243 5 5-2.243 5-5 5z"
              ></path></svg
            >
          </span>
          <input
            id="ai-search-input"
            class="block w-full rounded border border-skin-fill bg-skin-fill py-3 pl-10 pr-3"
            placeholder="搜索工具..."
          />
        </label>
        <div id="ai-search-count" class="text-skin-muted mt-4 text-sm"></div>
      </section>

      <section id="ai-list" class="mt-8">
        {
          categories.map(([category, items]) => (
            <div class="category mb-8" data-category={category}>
              <h2 class="text-xl font-semibold">{category}</h2>
              <div class="mt-3 grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-6">
                {items.map((tool: any) => (
                  <div class="card relative rounded-lg bg-skin-card p-3 shadow-md transition-shadow hover:shadow-lg">
                    <a
                      class="block text-lg font-medium text-skin-accent"
                      href={tool.href}
                      target="_blank"
                      rel="noopener"
                    >
                      <div class="mb-2 flex items-center">
                        {tool.icon && (
                          <img
                            src={tool.icon}
                            alt={`${tool.title} 图标`}
                            class="mr-2 h-6 w-6"
                          />
                        )}
                        <h3 class="m-0">{tool.title}</h3>
                      </div>
                    </a>
                    <div class="card-description-wrapper">
                      <div class="card-description text-skin-muted mb-2 text-sm">
                        <p>{tool.description}</p>
                      </div>
                      <div class="tooltip">{tool.description}</div>
                    </div>
                    {tool.tags && tool.tags.length > 0 && (
                      <div class="flex flex-wrap gap-1">
                        {(tool.tags as string[]).map(tag => (
                          <span class="rounded bg-skin-fill px-2 py-0.5 text-xs">
                            {tag}
                          </span>
                        ))}
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          ))
        }
        <!-- JS 渲染的搜索结果将注入到 #ai-results -->
        <div id="ai-results"></div>
      </section>
    </main>

    <Footer />
  </div>
</WideLayout>

<style is:global>
  /* 覆盖默认的窄宽度限制 */
  .wide-layout section,
  .wide-layout footer {
    max-width: 1600px !important;
  }

  .wide-layout .nav-container {
    max-width: 1600px !important;
  }
</style>

<style>
  #ai-hero h1 {
    @apply my-4 text-3xl font-bold sm:text-4xl;
  }
  #ai-search input:focus {
    @apply outline-none ring-2 ring-sky-300;
  }
  .card {
    @apply border border-skin-fill;
    position: relative;
  }
  .card:hover {
    @apply border-skin-accent;
  }
  .card-description-wrapper {
    position: relative;
  }
  .card-description {
    @apply line-clamp-2;
    cursor: help;
  }
  .card-description p {
    margin: 0;
  }
  .tooltip {
    position: absolute;
    background: #333;
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    white-space: normal;
    max-width: 400px;
    min-width: 280px;
    z-index: 1000;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease-in-out;
    line-height: 1.4;
  }
  .tooltip::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: #333;
  }
  .card-description-wrapper:hover .tooltip {
    opacity: 1;
    pointer-events: auto;
  }
</style>

<script type="module">
  // 将服务端的 tools 嵌入到 window 以供客户端搜索使用
  window.__AI_TOOLS__ = JSON.parse(
    decodeURIComponent("${encodeURIComponent(JSON.stringify(tools))}")
  );

  import Fuse from "fuse.js";

  const toolsData = window.__AI_TOOLS__ || [];
  const fuse = new Fuse(toolsData, {
    keys: ["title", "description", "category"],
    threshold: 0.4,
  });

  const input = document.getElementById("ai-search-input");
  const listEl = document.getElementById("ai-list");
  const countEl = document.getElementById("ai-search-count");

  function renderResults(results) {
    // results: 结果数组（如果为 'grouped' 则显示分组类别）
    if (!listEl) return;
    if (!results) return;

    // If results is a string 'grouped', render grouped categories (initial state)
    if (results === "grouped") {
      // 恢复服务端渲染的分组视图（此处不重新渲染 HTML，保留 Astro 生成的静态标记）
      if (countEl) countEl.textContent = "";
      const categories = listEl.querySelectorAll(".category");
      categories.forEach(c => {
        if (c instanceof HTMLElement) c.style.display = "";
      });
      const items = listEl.querySelectorAll("li");
      items.forEach(i => {
        if (i instanceof HTMLElement) i.style.display = "";
      });
      return;
    }
    // results 是 Fuse 返回的结果数组：{ item, refIndex }
    const resultsContainer = document.getElementById("ai-results");
    if (!resultsContainer) return;

    // 隐藏服务端渲染的分组列表
    const categoriesEls = listEl.querySelectorAll(".category");
    categoriesEls.forEach(c => {
      if (c instanceof HTMLElement) c.style.display = "none";
    });

    // build HTML for results
    let visible = 0;
    const parts = [];
    parts.push(
      '<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-6 gap-3">'
    );
    results.forEach(r => {
      const t = r.item;
      visible++;
      // 简单高亮：将匹配到的词用 <mark> 包裹
      function highlight(text) {
        try {
          const q = input && input.value ? input.value.trim() : "";
          if (!q) return text;
          const esc = q.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
          const re = new RegExp(esc, "ig");
          return String(text).replace(re, m => `<mark>${m}</mark>`);
        } catch (e) {
          return text;
        }
      }

      const iconHtml = t.icon
        ? `<img src="${t.icon}" alt="${t.title} 图标" class="w-6 h-6 mr-2" />`
        : "";
      const tagsHtml = (t.tags || [])
        .map(
          tag =>
            `<span class="inline-block ml-2 text-xs px-2 py-0.5 bg-skin-fill rounded">${tag}</span>`
        )
        .join("");

      // 对 tooltip 中的文本进行 HTML 转义
      const escapeHtml = text => {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      };

      parts.push(
        `<div class="card bg-skin-card p-3 rounded-lg shadow-md hover:shadow-lg transition-shadow relative">`
      );
      parts.push(
        `<a class="block text-lg font-medium text-skin-accent" href="${t.href}" target="_blank" rel="noopener"><div class="flex items-center mb-2">${iconHtml}<h3 class="m-0">${highlight(t.title)}</h3></div></a>`
      );
      parts.push(
        `<div class="card-description-wrapper"><div class="card-description text-sm text-skin-muted mb-2"><p>${highlight(t.description)}</p></div><div class="tooltip">${escapeHtml(t.description)}</div></div>`
      );
      parts.push(`<div class="flex flex-wrap gap-1">${tagsHtml}</div>`);
      parts.push("</div>");
    });
    parts.push("</div>");

    resultsContainer.innerHTML = parts.join("");
    if (countEl) countEl.textContent = `${visible} 条结果`;
  }

  if (!input) {
    renderResults("grouped");
  } else {
    // initial state
    renderResults("grouped");

    input.addEventListener("input", e => {
      const q = e.target && e.target.value ? e.target.value.trim() : "";
      if (!q) {
        renderResults("grouped");
        return;
      }
      const res = fuse.search(q);
      renderResults(res);
    });
  }
</script>
